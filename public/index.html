<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <title>Lyra — Assistente IA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="index.css">
</head>

<body>
  <div class="wrap">
    <h1>Lyra — IA</h1>

    <div id="status-modelo">
      <strong>Rodando no Groq</strong> — Mixtral 8x7B
    </div>

    <p>
      Sou Lyra, uma assistente de inteligência artificial desenvolvida por Mykoll.
      Meu objetivo é fornecer respostas claras, objetivas e informativas.
      Estou em processo contínuo de aprendizado e, caso apresente alguma
      informação incorreta, aprecio que me corrijam para aprimorar minha precisão.
    </p>

    <textarea id="mensagem" placeholder="Digite sua pergunta..."></textarea><br>
    <button id="enviar">Enviar</button>
    <button id="limparMemoria">Limpar Memória</button>
  </div>

  <div id="align-resposta">
    <div id="resposta">Pronta para responder...</div>
  </div>

  <div id="loading">Gerando resposta…</div>
  <div id="vanta-bg"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
  <script>
    VANTA.GLOBE({ el: "#vanta-bg", mouseControls: false, touchControls: false, scale: 1.00 });

    const $msg = document.getElementById('mensagem');
    const $resposta = document.getElementById('resposta');
    const $loading = document.getElementById('loading');
    const $enviar = document.getElementById('enviar');
    const $limparMemoria = document.getElementById('limparMemoria');
    let controller = null;

    // Detecta se está no Vercel ou local
    const API_BASE = window.location.hostname.includes('vercel.app') ? '/api' : '';

    function setLoading(on) {
      $loading.style.display = on ? 'flex' : 'none';
    }

    // Funções para gerenciar memória no navegador (Vercel)
    function getMemory() {
      return JSON.parse(localStorage.getItem('lyra_memory') || '[]');
    }

    function saveMemory(memory) {
      localStorage.setItem('lyra_memory', JSON.stringify(memory));
    }

    $enviar.onclick = async () => {
      const pergunta = $msg.value.trim();
      if (!pergunta) return;

      if (controller) controller.abort();
      controller = new AbortController();

      $resposta.textContent = '';
      setLoading(true);

      // pega histórico salvo no navegador
      const memory = getMemory();
      memory.push({ role: 'user', content: pergunta });
      saveMemory(memory);

      try {
        const r = await fetch(`${API_BASE}/perguntar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mensagem: pergunta,
            messages: memory // manda o histórico pro backend híbrido
          }),
          signal: controller.signal
        });

        if (!r.body) throw new Error("Sem corpo de resposta");
        const reader = r.body.getReader();
        const decoder = new TextDecoder();
        let partial = '';
        let firstToken = true;
        let fullAnswer = '';

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          partial += decoder.decode(value, { stream: true });

          const lines = partial.split('\n');
          partial = lines.pop() || '';

          for (const line of lines) {
            if (!line.trim()) continue;
            try {
              const obj = JSON.parse(line);
              if (obj.delta) {
                if (firstToken) {
                  setLoading(false);
                  firstToken = false;
                }
                fullAnswer += obj.delta;
                $resposta.textContent += obj.delta;
              }
              if (obj.error) {
                $resposta.textContent = 'Erro: ' + obj.error;
              }
            } catch (e) {
              console.error("Linha inválida do stream:", line);
            }
          }
        }

        // salva resposta no histórico do navegador
        memory.push({ role: 'assistant', content: fullAnswer || '(Sem resposta)' });
        saveMemory(memory);

      } catch (err) {
        if (err.name !== 'AbortError') {
          $resposta.textContent = 'Erro: ' + err.message;
        }
      } finally {
        setLoading(false);
      }
    };

    $limparMemoria.onclick = async () => {
      localStorage.removeItem('lyra_memory');
      await fetch(`${API_BASE}/memory`, { method: 'DELETE' });
      $resposta.textContent = 'Memória apagada.';
    };

    // Faz a primeira letra ser maiúscula
    $msg.addEventListener('input', () => {
      if ($msg.value.length === 1) {
        $msg.value = $msg.value.toUpperCase();
      }
    });
  </script>
</body>
</html>
